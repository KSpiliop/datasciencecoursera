---
Coursera Reproducible Research Project 2
---

## Weather Events with Critical Impact on Health and Economy

Synopsis
This analysis attempts to isolate weather events that 1) are most harmful to population health and 2) have the greatest economic consequences.  Using data from the U.S. National Oceanic and Atmospheric Administration's (NOAA) storm database, fatalities and damages are used to approximate population health damage, and crop and property damage is used to approximate economic consequences.  To assess only the most critical impact, the data set is cut to only reflect damages of 95% percentile and above.  Then the weather events related to these damages are much easier to visualize.  

## Data Processing for Population Health
Import raw data 

```{r, echo=TRUE}
setwd("~/Desktop/Coursera/05_ReproducibleResearch/Project02")
df0_raw <- read.csv("repdata-data-StormData.csv")
```

Raw data has 902297 rows and 37 variables.

```{r, echo=TRUE}
dim(df0_raw) # [1] 902297     37
```

Remove data points where the event type is not relevant to analysis.

```{r, echo=TRUE}
evtype_summary_names <- grep("Summary", df0_raw$EVTYPE, value = TRUE)
```

```{r, echo=TRUE}
df0_evtype_no_summary <- df0_raw[!df0_raw$EVTYPE %in% evtype_summary_names, ]
```

The new data set has 902224 rows and 37 variables.

```{r, echo=TRUE}
dim(df0_evtype_no_summary) # [1] 902224     37
```

Aggregate weather type by total injuries.

```{r, echo=TRUE}
df1_evtype_by_injuries_sum <- aggregate(INJURIES ~ EVTYPE, data = df0_evtype_no_summary, FUN = "sum");
names(df1_evtype_by_injuries_sum) <- c("EVTYPE", "INJURIES_SUM")
```

Aggregate weather type by average injuries.

```{r, echo=TRUE}
df1_evtype_by_injuries_mean <- aggregate(INJURIES ~ EVTYPE, data = df0_evtype_no_summary, FUN = "mean")
names(df1_evtype_by_injuries_mean) <- c("EVTYPE", "INJURIES_MEAN")
```

Aggregate weather type by total fatalities.

```{r, echo=TRUE}
df1_evtype_by_fatalities_sum <- aggregate(FATALITIES ~ EVTYPE, data = df0_evtype_no_summary, FUN = "sum")
names(df1_evtype_by_fatalities_sum) <- c("EVTYPE", "FATALITIES_SUM")
```

Aggregate weather type by average fatalities.

```{r, echo=TRUE}
df1_evtype_by_fatalities_mean <- aggregate(FATALITIES ~ EVTYPE, data = df0_evtype_no_summary, FUN = "mean")
names(df1_evtype_by_fatalities_mean) <- c("EVTYPE", "FATALITIES_MEAN")
```

Merge all injuries and fatalities metrics together.  

```{r, echo=TRUE}
df2_injuries_by_evtype <- merge(df1_evtype_by_injuries_sum, df1_evtype_by_injuries_mean, by = "EVTYPE")
df2_fatalities_by_evtype <- merge(df1_evtype_by_fatalities_sum, df1_evtype_by_fatalities_mean, by = "EVTYPE")
df3_population_health_by_evtype <- merge(df2_fatalities_by_evtype, df2_injuries_by_evtype, by = "EVTYPE")
```

Calculate quantiles for total fatalities.

```{r, echo=TRUE}
fatalities_sum_quantile <- data.frame(quantile(df3_population_health_by_evtype$FATALITIES_SUM, c(0.5, 0.9, 0.95, 0.99)), c(0.50, 0.90, 0.95, 0.99))
names(fatalities_sum_quantile) <- c("value", "quantile")
```

Calculate quantiles for average fatalities.
```{r, echo=TRUE}
fatalities_mean_quantile <- data.frame(quantile(df3_population_health_by_evtype$FATALITIES_MEAN, c(0.5, 0.9, 0.95, 0.99)), c(0.50, 0.90, 0.95, 0.99))
names(fatalities_mean_quantile) <- c("value", "quantile")
```

Calculate quantiles for total injuries.

```{r, echo=TRUE}
injuries_sum_quantile <- data.frame(quantile(df3_population_health_by_evtype$INJURIES_SUM, c(0.5, 0.9, 0.95, 0.99)), c(0.50, 0.90, 0.95, 0.99))
names(injuries_sum_quantile) <- c("value", "quantile")
```

Calculate quantiles for average injuries.

```{r, echo=TRUE}
injuries_mean_quantile <- data.frame(quantile(df3_population_health_by_evtype$INJURIES_MEAN, c(0.5, 0.9, 0.95, 0.99)), c(0.50, 0.90, 0.95, 0.99))
names(injuries_mean_quantile) <- c("value", "quantile")
```

Apply 95% percentile cutoff to dataset.

```{r, echo = TRUE}
df4_population_health_by_evtype_95 <- df3_population_health_by_evtype[
  df3_population_health_by_evtype$FATALITIES_SUM >= fatalities_sum_quantile[3, 1]
  & df3_population_health_by_evtype$FATALITIES_MEAN >= fatalities_mean_quantile[3, 1]
  & df3_population_health_by_evtype$INJURIES_SUM >= injuries_sum_quantile[3, 1]
  & df3_population_health_by_evtype$INJURIES_MEAN >= injuries_mean_quantile[3, 1]
  ,]
```

Load library appropriate for plotting
```{r, echo=TRUE}
library(grid)
library(ggplot2)
source("multiplot.R") 
```

Plot sub panel for total fatalities by event type.
```{r, echo=TRUE}
a <- ggplot(df4_population_health_by_evtype_95, aes(x = EVTYPE, y = FATALITIES_SUM, fill = EVTYPE)) + geom_bar(stat = "identity") + labs(title = "Total Fatalities") + labs(x = "", y = "") + theme(legend.position="none") + scale_x_discrete(labels=c("EH1", "EH2", "HT", "HW", "TS")) + scale_fill_brewer()                                                                                                                                  
```

Plot sub panel for average fatalities by event type.
```{r, echo=TRUE}
b <- ggplot(df4_population_health_by_evtype_95, aes(x = EVTYPE, y = FATALITIES_MEAN, fill = EVTYPE)) + geom_bar(stat = "identity") + labs(title = "Average Fatalities") + labs(x = "", y = "") + theme(legend.position="none") + scale_x_discrete(labels=c("EH1", "EH2", "HT", "HW", "TS")) + scale_fill_brewer()                                                                                                                                  
```

Plot sub panel for total injuries by event type.
```{r, echo=TRUE}
c <- ggplot(df4_population_health_by_evtype_95, aes(x = EVTYPE, y = INJURIES_SUM, fill = EVTYPE)) + geom_bar(stat = "identity") + labs(title = "Total Injuries") + labs(x = "", y = "") + theme(legend.position="none") + scale_x_discrete(labels=c("EH1", "EH2", "HT", "HW", "TS")) + scale_fill_brewer()                                                                                                                                  
```

Plot sub panel for average injuries by event type.
```{r, echo=TRUE}
d <- ggplot(df4_population_health_by_evtype_95, aes(x = EVTYPE, y = INJURIES_MEAN, fill = EVTYPE)) + geom_bar(stat = "identity") + labs(title = "Average Injuries") + labs(x = "", y = "") + theme(legend.position="none") + scale_x_discrete(labels=c("EH1", "EH2", "HT", "HW", "TS")) + scale_fill_brewer()                                                                                                                                  
```

Combine all sub panels into one plot.
```{r, echo=TRUE}
multiplot(a, b, c, d, cols=2)
```



## Data Processing for Economy

Aggregate weather type by total property damage.

```{r, echo=TRUE}
df1_evtype_by_property_damage_sum <- aggregate(PROPDMG ~ EVTYPE, data = df0_evtype_no_summary, FUN = "sum")
names(df1_evtype_by_property_damage_sum) <- c("EVTYPE", "PROPDMG_SUM")
```

Aggregate weather type by average property damage.

```{r, echo=TRUE}
df1_evtype_by_property_damage_mean <- aggregate(PROPDMG ~ EVTYPE, data = df0_evtype_no_summary, FUN = "mean")
names(df1_evtype_by_property_damage_mean) <- c("EVTYPE", "PROPDMG_MEAN")
```

Aggregate weather type by total crop damage.

```{r, echo=TRUE}
df1_evtype_by_crop_damage_sum <- aggregate(CROPDMG ~ EVTYPE, data = df0_evtype_no_summary, FUN = "sum")
names(df1_evtype_by_crop_damage_sum) <- c("EVTYPE", "CROPDMG_SUM")
```

Aggregate weather type by average crop damage.

```{r, echo=TRUE}
df1_evtype_by_crop_damage_mean <- aggregate(CROPDMG ~ EVTYPE, data = df0_evtype_no_summary, FUN = "mean")
names(df1_evtype_by_crop_damage_mean) <- c("EVTYPE", "CROPDMG_MEAN")
```

Merge all property damage and crop damage metrics together.  

```{r, echo=TRUE}
df2_evtype_by_property_damage <- merge(df1_evtype_by_property_damage_sum, df1_evtype_by_property_damage_mean, by = "EVTYPE")
df2_evtype_by_crop_damage <- merge(df1_evtype_by_crop_damage_sum, df1_evtype_by_crop_damage_mean, by = "EVTYPE")
df3_evtype_by_economy <- merge(df2_evtype_by_property_damage, df2_evtype_by_crop_damage, by = "EVTYPE")
```

Calculate quantiles for total crop damage.

```{r, echo=TRUE}
crop_damage_sum_quantile <- data.frame(quantile(df3_evtype_by_economy$CROPDMG_SUM, c(0.5, 0.9, 0.95, 0.99)), c(0.50, 0.90, 0.95, 0.99))
names(crop_damage_sum_quantile) <- c("value", "quantile")
```

Calculate quantiles for average crop damage.
```{r, echo=TRUE}
crop_damage_mean_quantile <- data.frame(quantile(df3_evtype_by_economy$CROPDMG_MEAN, c(0.5, 0.9, 0.95, 0.99)), c(0.50, 0.90, 0.95, 0.99))
names(crop_damage_mean_quantile) <- c("value", "quantile")
```

Calculate quantiles for total property damage.

```{r, echo=TRUE}
property_damage_sum_quantile <- data.frame(quantile(df3_evtype_by_economy$PROPDMG_SUM, c(0.5, 0.9, 0.95, 0.99)), c(0.50, 0.90, 0.95, 0.99))
names(property_damage_sum_quantile) <- c("value", "quantile")
```

Calculate quantiles for average property damage.

```{r, echo=TRUE}
property_damage_mean_quantile <- data.frame(quantile(df3_evtype_by_economy$PROPDMG_MEAN, c(0.5, 0.9, 0.95, 0.99)), c(0.50, 0.90, 0.95, 0.99))
names(property_damage_mean_quantile) <- c("value", "quantile")
```

Apply 95% percentile cutoff to dataset.

```{r, echo = TRUE}
df4_evtype_by_economy_95 <- df3_evtype_by_economy[
  df3_evtype_by_economy$PROPDMG_SUM >= property_damage_sum_quantile[3, 1]
#   & df3_evtype_by_economy$PROPDMG_MEAN >= property_damage_mean_quantile[3, 1]
  & df3_evtype_by_economy$CROPDMG_SUM >= crop_damage_sum_quantile[3, 1]
  & df3_evtype_by_economy$CROPDMG_MEAN >= crop_damage_mean_quantile[3, 1]
  ,]
```

Plot sub panel for total crop damage by event type.
```{r, echo=TRUE}
a <- ggplot(df4_evtype_by_economy_95, aes(x = EVTYPE, y = CROPDMG_SUM, fill = EVTYPE)) + geom_bar(stat = "identity") + labs(title = "Total Crop Damage") + labs(x = "", y = "") + theme(legend.position="none") + scale_x_discrete(labels=c("DR", "FL", "HU", "HT", "RF")) + scale_fill_brewer()                                                                                                                                                                                                                                     
```

Plot sub panel for average crop damage by event type.
```{r, echo=TRUE}
b <- ggplot(df4_evtype_by_economy_95, aes(x = EVTYPE, y = CROPDMG_MEAN, fill = EVTYPE)) + geom_bar(stat = "identity") + labs(title = "Avg Crop Damage") + labs(x = "", y = "") + theme(legend.position="none") + scale_x_discrete(labels=c("DR", "FL", "HU", "HT", "RF")) + scale_fill_brewer()                                                                                                                                  
```

Plot sub panel for total property damage by event type.
```{r, echo=TRUE}
c <- ggplot(df4_evtype_by_economy_95, aes(x = EVTYPE, y = PROPDMG_SUM, fill = EVTYPE)) + geom_bar(stat = "identity") + labs(title = "Total Property Damage") + labs(x = "", y = "") + theme(legend.position="none") + scale_x_discrete(labels=c("DR", "FL", "HU", "HT", "RF")) + scale_fill_brewer()                                                                                                                                                                                                                                                               
```

Plot sub panel for average property damage by event type.
```{r, echo=TRUE}
d <- ggplot(df4_evtype_by_economy_95, aes(x = EVTYPE, y = PROPDMG_MEAN, fill = EVTYPE)) + geom_bar(stat = "identity") + labs(title = "Average Property Damage") + labs(x = "", y = "") + theme(legend.position="none") + scale_x_discrete(labels=c("DR", "FL", "HU", "HT", "RF")) + scale_fill_brewer()                                                                                                                                                                                                                                                                   
```

Combine all sub panels into one plot.
```{r, echo=TRUE}
multiplot(a, b, c, d, cols=2)
```

## Results


For fatalities and injuries 95% percentile and above, weather types associated with these metrics are as follow:

1. EH1 = Excessive Heat

2. EH2 = Extreme Heat

3. HT = Heat

4. HW = Heat Wave

5. TS = Tsunami


For crop and property damages 95% percentile and above, weather types associated with these metrics are as follow:

1. DR = Drought

2. FL = Flooding

3. HU = Hurricane

4. HT = Hurricane/Typhoon

5. RF = River Flood








